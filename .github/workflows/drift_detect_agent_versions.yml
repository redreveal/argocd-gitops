name: Manual Sync Configuration

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch to sync configurations to'
        required: true
        default: 'main'

jobs:
  sync-configurations:
    runs-on: ubuntu-latest
    outputs:
      changes_detected: ${{ steps.process_configs.outputs.changes_detected }}
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ARGOCD_GITOPS_VERSIONS_DEPLOYMENT_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Checkout source repository (current repo)
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Ensure we fetch all history for diffs

      - name: Checkout target repository using SSH
        uses: actions/checkout@v2
        with:
          repository: 'redreveal/argocd-gitops-versions'
          ssh-key: ${{ secrets.ARGOCD_GITOPS_VERSIONS_DEPLOYMENT_KEY }}
          path: target-repo
          ref: ${{ github.event.inputs.target_branch }}

      - name: Install Python and PyYAML
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install pyyaml

      - name: Compare and Update Configuration Files
        id: process_configs
        run: |
          changes_detected=false
          src_dir="$GITHUB_WORKSPACE/versions"
          trg_dir="$GITHUB_WORKSPACE/target-repo/versions"
          echo "Checking for differences..."
          for src_file in $(find $src_dir -name "processing-agent-config.yml"); do
            trg_file="${src_file/$src_dir/$trg_dir}"
            trg_file="${trg_file/processing-agent-config.yml/values.yaml}"
            echo "Checking $src_file against $trg_file"
            if python3 ./.github/actions/scripts/drift_detection_configs.py "$src_file" "$trg_file"; then
              echo "Updating due to differences: $src_file -> $trg_file"
              changes_detected=true
            fi
          done
          echo "changes_detected=$changes_detected" >> $GITHUB_ENV
        shell: bash

  update-configurations:
    needs: sync-configurations
    runs-on: ubuntu-latest
    if: ${{ needs.sync-configurations.outputs.changes_detected == 'true' }}
    environment:
      name: production
      url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ARGOCD_GITOPS_VERSIONS_DEPLOYMENT_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Checkout source repository (for updates)
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Ensure we fetch all history for diffs

      - name: Checkout target repository using SSH (for updates)
        uses: actions/checkout@v2
        with:
          repository: 'redreveal/argocd-gitops-versions'
          ssh-key: ${{ secrets.ARGOCD_GITOPS_VERSIONS_DEPLOYMENT_KEY }}
          path: target-repo
          ref: ${{ github.event.inputs.target_branch }}

      - name: Install Python and PyYAML (for updates)
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install pyyaml

      - name: Apply Changes and Push to Repository
        run: |
          src_dir="$GITHUB_WORKSPACE/versions"
          trg_dir="$GITHUB_WORKSPACE/target-repo/versions"
          for src_file in $(find $src_dir -name "processing-agent-config.yml"); do
            trg_file="${src_file/$src_dir/$trg_dir}"
            trg_file="${trg_file/processing-agent-config.yml/values.yaml}"
            if python3 ./.github/actions/scripts/drift_detection_configs.py "$src_file" "$trg_file"; then
              echo "Applying changes: $src_file -> $trg_file"
              python3 ./.github/actions/scripts/process_values_to_cm.py "$src_file" "$trg_file"
              cd $GITHUB_WORKSPACE/target-repo
              git config user.email "rberisha@revealdata.com"
              git config user.name "Redon Berisha"
              git add "$trg_file"
              git commit -m "Updated configurations based on detected drifts"
              git push
            fi
          done
        env:
          GIT_SSH_COMMAND: "ssh -i ~/.ssh/id_rsa"
